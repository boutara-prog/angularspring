<div class="container mt-4">
  <!-- Badge du rôle utilisateur -->
  <div class="row mb-3">
    <div class="col-12">
      <div class="alert alert-info" *ngIf="currentUser">
        <i class="fas fa-user"></i> Connecté en tant que: 
        <strong>{{ currentUser.username }}</strong> 
        <span class="badge bg-primary ms-2">{{ userRole }}</span>
        <span *ngIf="isFournisseur" class="text-muted ms-2">
          ({{ currentUser.email }})
        </span>
      </div>
    </div>
  </div>

  <!-- Titre principal -->
  <h2>
    <i class="fas fa-boxes"></i>
    <span *ngIf="isFournisseur">Gestion de Mon Stock</span>
    <span *ngIf="isAdmin">Gestion Globale des Stocks</span>
  </h2>

  <!-- Statistiques -->
  <div class="row mb-4">
    <div class="col-md-3">
      <div class="card bg-primary text-white shadow-sm">
        <div class="card-body">
          <h5><i class="fas fa-box"></i> Total Produits</h5>
          <h2 class="mb-0">{{ getTotalProduits() }}</h2>
        </div>
      </div>
    </div>
    <div class="col-md-3">
      <div class="card bg-success text-white shadow-sm">
        <div class="card-body">
          <h5><i class="fas fa-check-circle"></i> En Stock</h5>
          <h2 class="mb-0">{{ getProduitsEnStock() }}</h2>
        </div>
      </div>
    </div>
    <div class="col-md-3">
      <div class="card bg-warning text-white shadow-sm">
        <div class="card-body">
          <h5><i class="fas fa-exclamation-triangle"></i> Stock Faible</h5>
          <h2 class="mb-0">{{ getProduitsStockFaible() }}</h2>
        </div>
      </div>
    </div>
    <div class="col-md-3">
      <div class="card bg-danger text-white shadow-sm">
        <div class="card-body">
          <h5><i class="fas fa-times-circle"></i> Rupture</h5>
          <h2 class="mb-0">{{ getProduitsEnRupture() }}</h2>
        </div>
      </div>
    </div>
  </div>

  <!-- Filtre par fournisseur (Admin uniquement) -->
  <div class="row mb-3" *ngIf="isAdmin">
    <div class="col-md-4">
      <label class="form-label">Filtrer par Fournisseur</label>
      <select class="form-select" [(ngModel)]="selectedFournisseurId" 
              (change)="loadStocksByFournisseur()">
        <option [value]="null">Tous les fournisseurs</option>
        <option *ngFor="let fournisseur of fournisseurs" [value]="fournisseur.idFour">
          {{ fournisseur.entreprise }} - {{ fournisseur.nom }} {{ fournisseur.prenom }}
        </option>
      </select>
    </div>
  </div>

  <!-- Filtres de recherche -->
  <div class="card mb-4">
    <div class="card-header">
      <h6><i class="fas fa-filter"></i> Filtres de Recherche</h6>
    </div>
    <div class="card-body">
      <div class="row">
        <div class="col-md-3">
          <label for="searchNomProduit" class="form-label">Nom du produit</label>
          <input type="text" class="form-control" id="searchNomProduit" 
                 [(ngModel)]="searchFilters.nomProduit" placeholder="Rechercher...">
        </div>
        
        <div class="col-md-3" *ngIf="isAdmin">
          <label for="searchFournisseur" class="form-label">Fournisseur</label>
          <select class="form-select" id="searchFournisseur" 
                  [(ngModel)]="searchFilters.fournisseurId">
            <option [value]="null">Tous</option>
            <option *ngFor="let fournisseur of fournisseurs" [value]="fournisseur.idFour">
              {{ fournisseur.entreprise }}
            </option>
          </select>
        </div>
        
        <div class="col-md-3">
          <label for="statut" class="form-label">Statut du stock</label>
          <select class="form-select" id="statut" [(ngModel)]="searchFilters.statut">
            <option value="">Tous</option>
            <option value="rupture">Rupture de stock</option>
            <option value="faible">Stock faible</option>
            <option value="stock">En stock</option>
          </select>
        </div>
        
        <div [class]="isAdmin ? 'col-md-3' : 'col-md-6'" class="d-flex align-items-end">
          <div class="d-flex gap-2 w-100">
            <button class="btn btn-outline-primary flex-grow-1" (click)="applyFilters()">
              <i class="fas fa-search"></i> Rechercher
            </button>
            <button class="btn btn-outline-secondary flex-grow-1" (click)="clearFilters()">
              <i class="fas fa-times"></i> Effacer
            </button>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Formulaire de mise à jour de quantité -->
  <div class="card mb-4" *ngIf="showUpdateForm && selectedStock">
    <div class="card-header bg-warning text-white">
      <h5><i class="fas fa-edit"></i> Modifier la Quantité</h5>
    </div>
    <div class="card-body">
      <div class="row align-items-center">
        <div class="col-md-4">
          <strong>Produit:</strong> {{ selectedStock.produit?.nomProd }}
        </div>
        <div class="col-md-3">
          <strong>Quantité actuelle:</strong> 
          <span [class]="getStockClass(selectedStock.quantiteStock || 0)" class="fs-5 fw-bold">
            {{ selectedStock.quantiteStock || 0 }}
          </span>
        </div>
        <div class="col-md-3">
          <label for="updateQuantite" class="form-label">Nouvelle Quantité</label>
          <input type="number" class="form-control" id="updateQuantite" 
                 [(ngModel)]="updateQuantite" min="0">
        </div>
        <div class="col-md-2">
          <div class="d-flex gap-2">
            <button class="btn btn-success" (click)="saveQuantite()">
              <i class="fas fa-save"></i> Enregistrer
            </button>
            <button class="btn btn-secondary" (click)="hideUpdateForm()">
              <i class="fas fa-times"></i>
            </button>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Affichage pour FOURNISSEUR : Une seule liste -->
  <div class="card" *ngIf="isFournisseur">
    <div class="card-header">
      <h5><i class="fas fa-warehouse"></i> Mon Stock ({{ stocks.length }} produits)</h5>
    </div>
    <div class="card-body">
      <div class="table-responsive">
        <table class="table table-striped table-hover">
          <thead>
            <tr>
              <th>ID Stock</th>
              <th>Produit</th>
              <th>Description</th>
              <th>Prix (€)</th>
              <th>Quantité Disponible</th>
              <th>Statut</th>
              <th>Actions</th>
            </tr>
          </thead>
          <tbody>
            <tr *ngFor="let stock of stocks">
              <td>{{ stock.id }}</td>
              <td><strong>{{ stock.produit?.nomProd || 'N/A' }}</strong></td>
              <td>{{ stock.produit?.description || 'Aucune description' }}</td>
              <td><strong>{{ stock.produit?.prix | currency:'EUR':'symbol':'1.2-2' }}</strong></td>
              <td class="text-center">
                <h5 class="mb-0" [class]="getStockClass(stock.quantiteStock)">
                  {{ stock.quantiteStock }}
                </h5>
              </td>
              <td>
                <span [class]="'badge ' + getStockBadgeClass(stock.quantiteStock)">
                  {{ getStockStatus(stock.quantiteStock) }}
                </span>
              </td>
              <td>
                <button class="btn btn-sm btn-warning" 
                        (click)="openUpdateForm(stock)"
                        title="Modifier la quantité">
                  <i class="fas fa-edit"></i> Modifier
                </button>
              </td>
            </tr>
          </tbody>
        </table>
        
        <!-- Message si aucun stock -->
        <div class="alert alert-info mt-3" *ngIf="stocks.length === 0">
          <i class="fas fa-info-circle"></i> Vous n'avez pas encore de produits en stock.
        </div>
      </div>
    </div>
  </div>

  <!-- Affichage pour ADMIN : Groupé par fournisseur -->
  <div *ngIf="isAdmin">
    <!-- Affichage groupé si aucun filtre fournisseur spécifique -->
    <div *ngIf="!selectedFournisseurId">
      <div class="card mb-4" *ngFor="let entry of getStocksByFournisseur() | keyvalue">
        <div class="card-header bg-secondary text-white">
          <h5>
            <i class="fas fa-building"></i> {{ entry.key }} 
            <span class="badge bg-light text-dark ms-2">{{ entry.value.length }} produits</span>
          </h5>
        </div>
        <div class="card-body">
          <div class="table-responsive">
            <table class="table table-striped table-hover mb-0">
              <thead>
                <tr>
                  <th>ID Stock</th>
                  <th>Produit</th>
                  <th>Description</th>
                  <th>Prix (€)</th>
                  <th>Quantité</th>
                  <th>Statut</th>
                  <th>Actions</th>
                </tr>
              </thead>
              <tbody>
                <tr *ngFor="let stock of entry.value">
                  <td>{{ stock.id }}</td>
                  <td><strong>{{ stock.produit?.nomProd || 'N/A' }}</strong></td>
                  <td>{{ stock.produit?.description || 'Aucune description' }}</td>
                  <td><strong>{{ stock.produit?.prix | currency:'EUR':'symbol':'1.2-2' }}</strong></td>
                  <td class="text-center">
                    <h5 class="mb-0" [class]="getStockClass(stock.quantiteStock)">
                      {{ stock.quantiteStock }}
                    </h5>
                  </td>
                  <td>
                    <span [class]="'badge ' + getStockBadgeClass(stock.quantiteStock)">
                      {{ getStockStatus(stock.quantiteStock) }}
                    </span>
                  </td>
                  <td>
                    <button class="btn btn-sm btn-warning" 
                            (click)="openUpdateForm(stock)"
                            title="Modifier la quantité">
                      <i class="fas fa-edit"></i> Modifier
                    </button>
                  </td>
                </tr>
              </tbody>
            </table>
          </div>
        </div>
      </div>

      <!-- Message si aucun stock -->
      <div class="alert alert-info" *ngIf="stocks.length === 0">
        <i class="fas fa-info-circle"></i> Aucun stock trouvé.
      </div>
    </div>

    <!-- Affichage simple si un fournisseur est sélectionné -->
    <div class="card" *ngIf="selectedFournisseurId">
      <div class="card-header">
        <h5>
          <i class="fas fa-boxes"></i> Stocks 
          ({{ stocks.length }} produits)
        </h5>
      </div>
      <div class="card-body">
        <div class="table-responsive">
          <table class="table table-striped table-hover">
            <thead>
              <tr>
                <th>ID Stock</th>
                <th>Produit</th>
                <th>Description</th>
                <th>Fournisseur</th>
                <th>Prix (€)</th>
                <th>Quantité</th>
                <th>Statut</th>
                <th>Actions</th>
              </tr>
            </thead>
            <tbody>
              <tr *ngFor="let stock of stocks">
                <td>{{ stock.id }}</td>
                <td><strong>{{ stock.produit?.nomProd || 'N/A' }}</strong></td>
                <td>{{ stock.produit?.description || 'Aucune description' }}</td>
                <td>
                  <span class="badge bg-secondary">
                    {{ stock.produit?.fournisseur?.entreprise || 'N/A' }}
                  </span>
                </td>
                <td><strong>{{ stock.produit?.prix | currency:'EUR':'symbol':'1.2-2' }}</strong></td>
                <td class="text-center">
                  <h5 class="mb-0" [class]="getStockClass(stock.quantiteStock)">
                    {{ stock.quantiteStock }}
                  </h5>
                </td>
                <td>
                  <span [class]="'badge ' + getStockBadgeClass(stock.quantiteStock)">
                    {{ getStockStatus(stock.quantiteStock) }}
                  </span>
                </td>
                <td>
                  <button class="btn btn-sm btn-warning" 
                          (click)="openUpdateForm(stock)"
                          title="Modifier la quantité">
                    <i class="fas fa-edit"></i> Modifier
                  </button>
                </td>
              </tr>
            </tbody>
          </table>
          
          <!-- Message si aucun stock -->
          <div class="alert alert-info mt-3" *ngIf="stocks.length === 0">
            <i class="fas fa-info-circle"></i> Aucun stock trouvé pour ce fournisseur.
          </div>
        </div>
      </div>
    </div>
  </div>
</div>