<div class="container mt-4">
  <!-- Badge du rôle utilisateur -->
  <div class="alert alert-info mb-3" *ngIf="currentUser">
    <i class="fas fa-user"></i> Connecté en tant que: 
    <strong>{{ currentUser.username || currentUser.email }}</strong> 
    <span class="badge bg-primary ms-2">{{ isAdmin ? 'ADMIN' : isFournisseur ? 'FOURNISSEUR' : 'CLIENT' }}</span>
  </div>

  <!-- Stats Cards (Masquées pour le fournisseur) -->
  <div class="row mb-4" *ngIf="!isFournisseur">
    <div class="col-lg-3 col-md-6">
      <div class="stats-card fade-in">
        <div class="d-flex justify-content-between align-items-center">
          <div>
            <h3>{{ fournisseurs.length }}</h3>
            <p class="mb-0">Fournisseurs Total</p>
          </div>
          <i class="fas fa-truck icon"></i>
        </div>
      </div>
    </div>
    <div class="col-lg-3 col-md-6">
      <div class="stats-card success fade-in">
        <div class="d-flex justify-content-between align-items-center">
          <div>
            <h3>{{ getActiveFournisseurs() }}</h3>
            <p class="mb-0">Actifs</p>
          </div>
          <i class="fas fa-check-circle icon"></i>
        </div>
      </div>
    </div>
    <div class="col-lg-3 col-md-6">
      <div class="stats-card warning fade-in">
        <div class="d-flex justify-content-between align-items-center">
          <div>
            <h3>{{ getNewFournisseurs() }}</h3>
            <p class="mb-0">Nouveaux ce mois</p>
          </div>
          <i class="fas fa-plus-circle icon"></i>
        </div>
      </div>
    </div>
    <div class="col-lg-3 col-md-6">
      <div class="stats-card danger fade-in">
        <div class="d-flex justify-content-between align-items-center">
          <div>
            <h3>{{ getTotalProducts() }}</h3>
            <p class="mb-0">Produits Total</p>
          </div>
          <i class="fas fa-boxes icon"></i>
        </div>
      </div>
    </div>
  </div>

  <!-- Quick Actions -->
  <div class="quick-actions fade-in">
    <h5><i class="fas fa-bolt"></i> Actions Rapides</h5>
    <div class="d-flex flex-wrap gap-2">
      <!-- Bouton Nouveau Fournisseur - Admin uniquement -->
      <button class="btn btn-primary" (click)="showAddForm()" *ngIf="canAdd()">
        <i class="fas fa-plus"></i> Nouveau Fournisseur
      </button>
      
      <!-- Import/Export - Admin uniquement -->
      <label class="btn btn-success" *ngIf="canImport()">
        <i class="fas fa-file-import"></i> Importer Données
        <input type="file" accept=".csv,.xlsx,.xls" (change)="importFromFile($event)" style="display: none;">
      </label>
      
      <button class="btn btn-warning text-white" (click)="exportToCSV()" *ngIf="canExport()">
        <i class="fas fa-file-export"></i> Exporter CSV
      </button>
      
      <button class="btn btn-info text-white" (click)="exportToExcel()" *ngIf="canExport()">
        <i class="fas fa-file-excel"></i> Exporter Excel
      </button>
      
      <!-- Bouton Actualiser pour tous -->
      <button class="btn btn-secondary" (click)="refreshList()">
        <i class="fas fa-sync-alt"></i> Actualiser
      </button>
    </div>
  </div>

  <!-- Formulaire d'ajout/modification -->
  <div class="card mb-4 fade-in" *ngIf="showForm">
    <div class="card-header d-flex justify-content-between align-items-center">
      <h5>
        <i class="fas fa-{{ isEditing ? 'edit' : 'plus' }}"></i>
        {{ isEditing ? 'Modifier' : 'Ajouter' }} un Fournisseur
      </h5>
      <button class="btn btn-sm btn-close" (click)="hideForm()"></button>
    </div>
    <div class="card-body">
      <form (ngSubmit)="saveFournisseur()" #fournisseurForm="ngForm">
        <div class="row">
          <div class="col-md-6">
            <div class="mb-3">
              <label for="nom" class="form-label">
                <i class="fas fa-user"></i> Nom *
              </label>
              <input type="text" class="form-control" id="nom" 
                     [(ngModel)]="newFournisseur.nom" name="nom" required>
            </div>
          </div>
          <div class="col-md-6">
            <div class="mb-3">
              <label for="prenom" class="form-label">
                <i class="fas fa-user"></i> Prénom *
              </label>
              <input type="text" class="form-control" id="prenom" 
                     [(ngModel)]="newFournisseur.prenom" name="prenom" required>
            </div>
          </div>
        </div>
        
        <div class="row">
          <div class="col-md-6">
            <div class="mb-3">
              <label for="email" class="form-label">
                <i class="fas fa-envelope"></i> Email *
              </label>
              <input type="email" class="form-control" id="email" 
                     [(ngModel)]="newFournisseur.email" name="email" required>
            </div>
          </div>
          <div class="col-md-6">
            <div class="mb-3">
              <label for="telephone" class="form-label">
                <i class="fas fa-phone"></i> Téléphone *
              </label>
              <input type="tel" class="form-control" id="telephone" 
                     [(ngModel)]="newFournisseur.telephone" name="telephone" required>
            </div>
          </div>
        </div>

        <div class="mb-3">
          <label for="adresse" class="form-label">
            <i class="fas fa-map-marker-alt"></i> Adresse *
          </label>
          <textarea class="form-control" id="adresse" rows="3" 
                    [(ngModel)]="newFournisseur.adresse" name="adresse" required></textarea>
        </div>

        <div class="mb-3">
          <label for="entreprise" class="form-label">
            <i class="fas fa-building"></i> Entreprise *
          </label>
          <input type="text" class="form-control" id="entreprise" 
                 [(ngModel)]="newFournisseur.entreprise" name="entreprise" required>
        </div>

        <div class="d-flex gap-2">
          <button type="submit" class="btn btn-success" [disabled]="!fournisseurForm.form.valid">
            <i class="fas fa-save"></i> {{ isEditing ? 'Modifier' : 'Ajouter' }}
          </button>
          <button type="button" class="btn btn-secondary" (click)="hideForm()">
            <i class="fas fa-times"></i> Annuler
          </button>
        </div>
      </form>
    </div>
  </div>

  <!-- Filtres de recherche (Masqués pour le fournisseur) -->
  <div class="card mb-4 fade-in" *ngIf="showFilters()">
    <div class="card-header">
      <h5><i class="fas fa-filter"></i> Filtres de Recherche</h5>
    </div>
    <div class="card-body">
      <div class="row">
        <div class="col-md-4">
          <label for="searchNom" class="form-label">Nom/Prénom/Email</label>
          <div class="input-group">
            <input type="text" class="form-control" id="searchNom" 
                   [(ngModel)]="searchTerm" placeholder="Rechercher..."
                   (input)="filterFournisseurs()">
            <button class="btn btn-outline-primary" type="button">
              <i class="fas fa-search"></i>
            </button>
          </div>
        </div>
        <div class="col-md-3">
          <label for="searchEntreprise" class="form-label">Entreprise</label>
          <select class="form-select" id="searchEntreprise" 
                  [(ngModel)]="selectedEntreprise" (change)="filterFournisseurs()">
            <option value="">Toutes les entreprises</option>
            <option *ngFor="let entreprise of getUniqueEntreprises()" [value]="entreprise">
              {{ entreprise }}
            </option>
          </select>
        </div>
        <div class="col-md-3">
          <label for="sortBy" class="form-label">Trier par</label>
          <select class="form-select" id="sortBy" 
                  [(ngModel)]="sortBy" (change)="sortFournisseurs()">
            <option value="nom">Nom</option>
            <option value="entreprise">Entreprise</option>
            <option value="email">Email</option>
          </select>
        </div>
        <div class="col-md-2 d-flex align-items-end">
          <button class="btn btn-outline-secondary w-100" (click)="clearFilters()">
            <i class="fas fa-times"></i> Effacer
          </button>
        </div>
      </div>
    </div>
  </div>

  <!-- Liste des fournisseurs -->
  <div class="card fade-in">
    <div class="card-header d-flex justify-content-between align-items-center">
      <h5>
        <i class="fas fa-list"></i> 
        {{ getPageTitle() }} 
        ({{ filteredFournisseurs.length }})
      </h5>
      <div class="d-flex gap-2">
        <button class="btn btn-sm btn-outline-primary" (click)="refreshList()">
          <i class="fas fa-sync-alt"></i> Actualiser
        </button>
      </div>
    </div>
    <div class="card-body">
      <!-- Loading spinner -->
      <div class="text-center py-5" *ngIf="loading">
        <div class="spinner-border text-primary" role="status">
          <span class="visually-hidden">Chargement...</span>
        </div>
        <p class="mt-3 text-muted">Chargement des données...</p>
      </div>

      <!-- Table -->
      <div class="table-responsive" *ngIf="!loading">
        <table class="table table-striped table-hover">
          <thead>
            <tr>
              <th style="cursor: pointer" (click)="sort('idFour')">
                ID <i class="fas fa-sort"></i>
              </th>
              <th style="cursor: pointer" (click)="sort('nom')">
                Nom <i class="fas fa-sort"></i>
              </th>
              <th style="cursor: pointer" (click)="sort('prenom')">
                Prénom <i class="fas fa-sort"></i>
              </th>
              <th style="cursor: pointer" (click)="sort('email')">
                Email <i class="fas fa-sort"></i>
              </th>
              <th>Téléphone</th>
              <th style="cursor: pointer" (click)="sort('entreprise')">
                Entreprise <i class="fas fa-sort"></i>
              </th>
              <th>Actions</th>
            </tr>
          </thead>
          <tbody>
            <tr *ngFor="let fournisseur of paginatedFournisseurs; trackBy: trackByFn" 
                class="fade-in">
              <td>
                <span class="badge bg-primary">{{ fournisseur.idFour }}</span>
              </td>
              <td>
                <strong>{{ fournisseur.nom }}</strong>
              </td>
              <td>{{ fournisseur.prenom }}</td>
              <td>
                <a [href]="'mailto:' + fournisseur.email" class="text-decoration-none">
                  <i class="fas fa-envelope text-muted"></i> {{ fournisseur.email }}
                </a>
              </td>
              <td>
                <a [href]="'tel:' + fournisseur.telephone" class="text-decoration-none">
                  <i class="fas fa-phone text-muted"></i> {{ fournisseur.telephone }}
                </a>
              </td>
              <td>
                <span class="badge bg-secondary">{{ fournisseur.entreprise }}</span>
              </td>
              <td>
                <div class="btn-group" role="group">
                  <!-- Bouton Voir Produits - Pour tous les rôles -->
                  <button class="btn btn-sm btn-outline-success" 
                          (click)="viewProducts(fournisseur)"
                          title="Voir les produits">
                    <i class="fas fa-box"></i>
                  </button>
                  
                  <!-- Bouton Modifier - Selon permissions -->
                  <button class="btn btn-sm btn-outline-warning" 
                          (click)="editFournisseur(fournisseur)"
                          *ngIf="canEdit(fournisseur)"
                          title="Modifier">
                    <i class="fas fa-edit"></i>
                  </button>
                  
                  <!-- Bouton Supprimer - Admin uniquement -->
                  <button class="btn btn-sm btn-outline-danger" 
                          (click)="deleteFournisseur(fournisseur.idFour!)"
                          *ngIf="canDelete(fournisseur)"
                          title="Supprimer">
                    <i class="fas fa-trash"></i>
                  </button>
                </div>
              </td>
            </tr>
            
            <!-- Message si aucun résultat -->
            <tr *ngIf="filteredFournisseurs.length === 0">
              <td colspan="7" class="text-center py-5">
                <i class="fas fa-inbox fa-3x text-muted mb-3"></i>
                <h5 class="text-muted">Aucun fournisseur trouvé</h5>
                <p class="text-muted" *ngIf="searchTerm || selectedEntreprise">
                  Essayez de modifier vos critères de recherche
                </p>
                <p class="text-muted" *ngIf="!searchTerm && !selectedEntreprise && isFournisseur">
                  Votre profil n'a pas été trouvé. Contactez l'administrateur.
                </p>
                <button class="btn btn-primary mt-3" (click)="showAddForm()" 
                        *ngIf="!searchTerm && !selectedEntreprise && canAdd()">
                  <i class="fas fa-plus"></i> Ajouter un Fournisseur
                </button>
              </td>
            </tr>
          </tbody>
        </table>
      </div>

      <!-- Pagination -->
      <nav *ngIf="filteredFournisseurs.length > pageSize && !loading">
        <ul class="pagination justify-content-center mb-3">
          <li class="page-item" [class.disabled]="currentPage === 1">
            <button class="page-link" (click)="goToPage(currentPage - 1)">
              <i class="fas fa-chevron-left"></i>
            </button>
          </li>
          <li class="page-item" 
              *ngFor="let page of getPageNumbers()" 
              [class.active]="page === currentPage">
            <button class="page-link" (click)="goToPage(page)">{{ page }}</button>
          </li>
          <li class="page-item" [class.disabled]="currentPage === getTotalPages()">
            <button class="page-link" (click)="goToPage(currentPage + 1)">
              <i class="fas fa-chevron-right"></i>
            </button>
          </li>
        </ul>
      </nav>

      <!-- Pagination info -->
      <div class="d-flex justify-content-between align-items-center mt-3" 
           *ngIf="filteredFournisseurs.length > 0 && !loading">
        <small class="text-muted">
          Affichage {{ getStartIndex() + 1 }} - {{ getEndIndex() }} sur {{ filteredFournisseurs.length }} fournisseur(s)
        </small>
        <div class="d-flex align-items-center">
          <label class="me-2 mb-0">Éléments par page:</label>
          <select class="form-select form-select-sm" style="width: auto;" 
                  [(ngModel)]="pageSize" (change)="onPageSizeChange()">
            <option [value]="5">5</option>
            <option [value]="10">10</option>
            <option [value]="25">25</option>
            <option [value]="50">50</option>
          </select>
        </div>
      </div>
    </div>
  </div>
</div>